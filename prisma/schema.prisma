generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model User {
  id            String         @id @default(cuid())
  username      String         @unique @db.VarChar(50)
  email         String?        @unique @db.VarChar(255)
  passwordHash  String         @map("password_hash") @db.VarChar(255)
  roles         String         @default("[]") @db.VarChar(200)
  createdAt     DateTime       @default(now()) @map("created_at")
  updatedAt     DateTime       @updatedAt @map("updated_at")
  sessions      Session[]
  videos        Video[]
  sponsorClaims SponsorClaim[]

  @@index([username])
  @@index([email])
  @@map("users")
}

model Session {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  token     String   @unique @db.VarChar(255)
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("sessions")
}

model Video {
  id                  String      @id @default(cuid())
  userId              String      @map("user_id")
  workflowId          String?     @map("workflow_id")
  originalImageUrl    String      @map("original_image_url") @db.VarChar(500)
  lastImageUrl        String?     @map("last_image_url") @db.VarChar(500)
  prompt              String?     @db.VarChar(2000)
  tags                String?     @db.VarChar(1000)
  suggestedPrompts    String?     @map("suggested_prompts") @db.VarChar(2000)
  isPhotoRealistic    Boolean?    @map("is_photo_realistic")
  isNsfw              Boolean?    @map("is_nsfw")
  status              String      @default("uploaded")
  jobId               String?     @map("job_id") @db.VarChar(200)
  isLocalJob          Boolean     @default(false) @map("is_local_job")
  finalVideoUrl       String?     @map("final_video_url") @db.VarChar(500)
  isPublished         Boolean     @default(false) @map("is_published")
  createdAt           DateTime    @default(now()) @map("created_at")
  updatedAt           DateTime    @updatedAt @map("updated_at")
  processingStartedAt DateTime?   @map("processing_started_at")
  dequeuedAt          DateTime?   @map("dequeued_at")
  processingTimeMs    Int?        @map("processing_time_ms")
  progressPercentage  Float?      @map("progress_percentage")
  progressDetails     Json?       @map("progress_details")
  iterationSteps      Int?        @map("iteration_steps")
  videoDuration       Int?        @map("video_duration")
  videoResolution     String?     @map("video_resolution") @db.VarChar(10)
  additionalOptions   Json?       @map("additional_options")
  loraWeights         Json?       @map("lora_weights")
  seed                Int?
  likes               VideoLike[]
  user                User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  workflow            Workflow?   @relation(fields: [workflowId], references: [id], onDelete: SetDefault)

  @@index([userId])
  @@index([workflowId])
  @@index([status])
  @@index([isPublished])
  @@index([isPublished, createdAt])
  @@index([isLocalJob, status, processingStartedAt])
  @@map("videos")
}

model VideoLike {
  id        String   @id @default(cuid())
  videoId   String   @map("video_id")
  userId    String   @map("user_id")
  createdAt DateTime @default(now()) @map("created_at")
  video     Video    @relation(fields: [videoId], references: [id], onDelete: Cascade)

  @@unique([videoId, userId])
  @@index([videoId])
  @@index([userId])
  @@map("video_likes")
}

model AdminSettings {
  id                     String   @id @default("default")
  registrationEnabled    Boolean  @default(true) @map("registration_enabled")
  roles                  Json?    @map("roles")
  quotaPerDay            Json     @default("{\"free\": 10, \"gmgard-user\": 50, \"paid\": 100, \"premium\": 100}") @map("quota_per_day")
  maxConcurrentJobs      Int      @default(5) @map("max_concurrent_jobs")
  maxQueueThreshold      Int      @default(5000) @map("max_queue_threshold")
  localQueueThreshold    Int      @default(0) @map("local_queue_threshold")
  localQueueMigrationThreshold Int @default(5) @map("local_queue_migration_threshold")
  freeUserWaitThresholdMinutes Int @default(30) @map("free_user_wait_threshold_minutes")
  freeUserQueueLimit     Int      @default(3) @map("free_user_queue_limit")
  paidUserQueueLimit     Int      @default(5) @map("paid_user_queue_limit")
  loraPresets            Json?    @map("lora_presets")
  sponsorApiUrl          String?  @map("sponsor_api_url") @db.VarChar(500)
  sponsorApiToken        String?  @map("sponsor_api_token") @db.VarChar(500)
  updatedAt              DateTime @updatedAt @map("updated_at")

  @@map("admin_settings")
}

model SponsorClaim {
  id                 String   @id @default(cuid())
  userId             String   @map("user_id")
  sponsorUsername    String   @map("sponsor_username") @db.VarChar(100)
  sponsorNickname    String?  @map("sponsor_nickname") @db.VarChar(255)
  sponsorAvatar      String?  @map("sponsor_avatar") @db.VarChar(500)
  sponsorTier        String   @map("sponsor_tier") @db.VarChar(50)
  appliedRole        String   @map("applied_role") @db.VarChar(50)
  claimedAt          DateTime @default(now()) @map("claimed_at")
  expiredAt          DateTime? @map("expired_at")
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([sponsorUsername])
  @@index([userId])
  @@index([sponsorUsername])
  @@map("sponsor_claims")
}

model Workflow {
  id                   String   @id
  name                 String   @db.VarChar(255)
  description          String?  @db.VarChar(500)
  templatePath         String   @db.VarChar(255)
  workflowType         String   @default("i2v") @map("workflow_type") @db.VarChar(10)
  compatibleLoraIds    Json     @default("[]") @map("compatible_lora_ids")
  isDefault            Boolean  @default(false) @map("is_default")
  createdAt            DateTime @default(now()) @map("created_at")
  updatedAt            DateTime @updatedAt @map("updated_at")
  videos               Video[]

  @@map("workflows")
}
